---
import Button from "@/components/ui/button.astro";
import { Avatar } from "@/components/profile/Avatar";
import { maybeGetLoggedInProfile } from "@/lib/profile";
import GoodStuff from "@/assets/goodstuff-goose.png";
import { Image } from "astro:assets";
import HeaderTicket from "./HeaderTicket.astro";

const profile = await maybeGetLoggedInProfile({
  request: Astro.request,
  cookies: Astro.cookies,
});

const navLinks = [
  { href: "/#tickets", label: "tickets" },
  { href: "/#talks", label: "talks" },
  { href: "/#faqs", label: "faqs" },
];
---

<header id="site-header" class="sticky top-0 z-10 bg-primary h-14 font-mono">
  <div
    class="h-full flex items-center justify-center gap-6 text-base relative z-10 bg-primary border-b sm:border-b-4 border-white"
  >
    <a
      id="site-logo"
      href="/"
      data-astro-reload
      class="flex items-center gap-1.5 font-semibold text-lg text-primary-foreground/80"
    >
      <Image
        id="header-goose"
        class="w-6 h-6 rounded-full object-cover object-top opacity-0 -ml-7 transition-all duration-300"
        src={GoodStuff}
        width={48}
        height={48}
        alt=""
      />
      <span><span class="text-blue-900">AT</span>mosphereConf</span>
    </a>
    <span class="text-white/30 select-none" aria-hidden="true">//</span>
    <nav class="flex items-center gap-4">
      <!-- desktop links -->
      <div class="hidden sm:flex items-center gap-4">
        {
          navLinks.map(({ href, label }) => (
            <a
              href={href}
              data-nav-section={href.replace("/#", "")}
              class="text-white/60 hover:text-white transition-colors"
            >
              {label}
            </a>
          ))
        }
      </div>
      <!-- mobile dropdown -->
      <div class="sm:hidden relative">
        <button
          id="nav-menu-btn"
          class="text-white/60 hover:text-white transition-colors flex items-center gap-1"
          aria-expanded="false"
          aria-haspopup="true"
        >
          menu
          <svg
            class="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <!-- little jank, but 'hidden' overrides flex -->
        <div
          id="nav-menu"
          class="flex hidden absolute right-0 top-full mt-1 bg-primary border border-white/20 rounded flex-col min-w-[50vw] w-max py-2"
        >
          {
            navLinks.map(({ href, label }) => (
              <a
                href={href}
                data-nav-section={href.replace("/#", "")}
                class="text-white/60 hover:text-white transition-colors px-4 py-2"
              >
                {label}
              </a>
            ))
          }
        </div>
      </div>
    </nav>
    <span class="text-white/30 select-none hidden md:inline" aria-hidden="true"
      >//</span
    >
    <!-- <div class="h-8 flex items-center">
            {
                profile ? (
                    <a href="/profile">
                        <Avatar
                            size="sm"
                            className="cursor-pointer ring-2 ring-white/50 hover:ring-white"
                            src={profile.avatarUrl}
                            alt={profile.displayName}
                        />
                    </a>
                ) : (
                    <a
                        href="/login"
                        class="font-mono text-base font-medium text-white border border-white/40 rounded px-3 py-1 hover:bg-white hover:text-primary transition-colors"
                    >
                        sign in
                    </a>
                )
            }
        </div> -->
  </div>

  <HeaderTicket />
</header>

<script>
  // Mobile nav dropdown
  const navMenuBtn = document.getElementById("nav-menu-btn");
  const navMenu = document.getElementById("nav-menu");
  if (navMenuBtn && navMenu) {
    navMenuBtn.addEventListener("click", () => {
      const open = navMenu.classList.toggle("hidden");
      navMenuBtn.setAttribute("aria-expanded", String(!open));
    });
    document.addEventListener("click", (e) => {
      if (
        !navMenuBtn.contains(e.target as Node) &&
        !navMenu.contains(e.target as Node)
      ) {
        navMenu.classList.add("hidden");
        navMenuBtn.setAttribute("aria-expanded", "false");
      }
    });
    navMenu.querySelectorAll("a").forEach((a) => {
      a.addEventListener("click", () => {
        navMenu.classList.add("hidden");
        navMenuBtn.setAttribute("aria-expanded", "false");
      });
    });
  }

  // On index page, logo scrolls to top instead of reloading
  const logo = document.getElementById("site-logo");
  if (logo && window.location.pathname === "/") {
    logo.addEventListener("click", (e) => {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: "smooth" });
      history.replaceState(null, "", "/");
    });
  }

  const goose = document.getElementById("header-goose");
  const hero = document.querySelector("[data-hero-goose]");
  if (goose && hero) {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          goose.classList.add("opacity-0", "-ml-7");
          goose.classList.remove("opacity-100", "ml-0");
        } else {
          goose.classList.remove("opacity-0", "-ml-7");
          goose.classList.add("opacity-100", "ml-0");
        }
      },
      { threshold: 0 },
    );
    observer.observe(hero);
  }

  // Highlight nav link for the section currently in view
  const navLinks =
    document.querySelectorAll<HTMLAnchorElement>("[data-nav-section]");
  const sections = new Map<string, Element>();
  navLinks.forEach((link) => {
    const id = link.dataset.navSection!;
    const el = document.getElementById(id);
    if (el) sections.set(id, el);
  });

  const active =
    "text-white underline decoration-dashed decoration-white/70 underline-offset-4";
  const inactive = "text-white/60";

  function setActive(id: string | null) {
    navLinks.forEach((link) => {
      const isActive = link.dataset.navSection === id;
      active.split(" ").forEach((c) => link.classList.toggle(c, isActive));
      inactive.split(" ").forEach((c) => link.classList.toggle(c, !isActive));
    });
  }

  let currentActive: string | null = null;
  const sectionObserver = new IntersectionObserver(
    (entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting) {
          currentActive = entry.target.id;
          setActive(currentActive);
          return;
        }
        // Clear if the currently active section left the viewport
        if (entry.target.id === currentActive) {
          currentActive = null;
          setActive(null);
        }
      }
    },
    { rootMargin: "-50% 0px -50% 0px" },
  );

  sections.forEach((el) => sectionObserver.observe(el));

  // Activate "tickets" nav when the header ticket banner appears
  window.addEventListener("ticket-banner", ((e: CustomEvent) => {
    if (e.detail.visible && !currentActive) {
      setActive("tickets");
    } else if (!e.detail.visible && currentActive === null) {
      setActive(null);
    }
  }) as EventListener);

  // Set initial active from URL hash
  const hash = window.location.hash.replace("#", "");
  if (hash && sections.has(hash)) setActive(hash);
</script>
